"""driver_loans_interim_payments_repairs models

Revision ID: 2cf88b5c1771
Revises: 28a5fb4e46cd
Create Date: 2025-10-29 18:06:48.230295

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision: str = '2cf88b5c1771'
down_revision: Union[str, Sequence[str], None] = '28a5fb4e46cd'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ezpass_import_history',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('batch_id', sa.String(length=100), nullable=False, comment='Unique batch identifier (EZPASS-YYYYMMDD-HHMMSS)'),
    sa.Column('import_type', sa.String(length=50), nullable=False, comment='CSV_UPLOAD or MANUAL_ENTRY'),
    sa.Column('file_name', sa.String(length=255), nullable=True, comment='Original CSV filename'),
    sa.Column('file_path', sa.String(length=500), nullable=True, comment='S3 path to uploaded file'),
    sa.Column('date_from', sa.Date(), nullable=True, comment='Start date filter for import'),
    sa.Column('date_to', sa.Date(), nullable=True, comment='End date filter for import'),
    sa.Column('status', sa.Enum('IN_PROGRESS', 'COMPLETED', 'COMPLETED_WITH_ERRORS', 'FAILED', name='importstatus'), nullable=False, comment='Import batch status'),
    sa.Column('total_rows_in_file', sa.Integer(), nullable=False, comment='Total rows in CSV'),
    sa.Column('total_transactions_imported', sa.Integer(), nullable=False, comment='Successfully imported transactions'),
    sa.Column('total_duplicates_skipped', sa.Integer(), nullable=False, comment='Duplicate tickets skipped'),
    sa.Column('total_auto_matched', sa.Integer(), nullable=False, comment='Transactions auto-matched to CURB trips'),
    sa.Column('total_manual_review', sa.Integer(), nullable=False, comment='Transactions requiring manual review'),
    sa.Column('total_unmapped', sa.Integer(), nullable=False, comment='Transactions with no mapping'),
    sa.Column('total_posted_to_ledger', sa.Integer(), nullable=False, comment='Transactions posted to ledger'),
    sa.Column('total_posting_failures', sa.Integer(), nullable=False, comment='Transactions that failed ledger posting'),
    sa.Column('total_errors', sa.Integer(), nullable=False, comment='Total errors encountered'),
    sa.Column('started_at', sa.DateTime(), nullable=False, comment='Import start time'),
    sa.Column('completed_at', sa.DateTime(), nullable=True, comment='Import completion time'),
    sa.Column('duration_seconds', sa.Integer(), nullable=True, comment='Total import duration'),
    sa.Column('error_log', sa.Text(), nullable=True, comment='JSON array of error messages'),
    sa.Column('summary', sa.Text(), nullable=True, comment='Human-readable import summary'),
    sa.Column('triggered_by', sa.String(length=50), nullable=False, comment='API, CELERY, or MANUAL'),
    sa.Column('triggered_by_user_id', sa.Integer(), nullable=True, comment='User who triggered import'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['triggered_by_user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ezpass_history_dates', 'ezpass_import_history', ['date_from', 'date_to'], unique=False)
    op.create_index('idx_ezpass_history_started', 'ezpass_import_history', ['started_at'], unique=False)
    op.create_index('idx_ezpass_history_status', 'ezpass_import_history', ['status'], unique=False)
    op.create_index(op.f('ix_ezpass_import_history_batch_id'), 'ezpass_import_history', ['batch_id'], unique=True)
    op.create_index(op.f('ix_ezpass_import_history_status'), 'ezpass_import_history', ['status'], unique=False)
    op.create_table('pvb_import_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('batch_id', sa.String(length=64), nullable=False, comment='Unique batch identifier (Format: PVB-IMPORT-YYYYMMDD-HHMMSS-XXXXX)'),
    sa.Column('import_source', sa.Enum('DOF_CSV', 'MANUAL_ENTRY', 'EMAIL', 'MAIL', name='violationsource'), nullable=False, comment='Source type of import'),
    sa.Column('file_name', sa.String(length=256), nullable=True, comment='Original filename'),
    sa.Column('status', sa.Enum('IN_PROGRESS', 'COMPLETED', 'PARTIAL', 'FAILED', name='importstatus'), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=False, comment='Import start time'),
    sa.Column('completed_at', sa.DateTime(), nullable=True, comment='Import completion time'),
    sa.Column('duration_seconds', sa.Integer(), nullable=True, comment='Total import duration'),
    sa.Column('total_records_in_file', sa.Integer(), nullable=False, comment='Total records in source file'),
    sa.Column('records_imported', sa.Integer(), nullable=False, comment='Successfully imported records'),
    sa.Column('records_skipped', sa.Integer(), nullable=False, comment='Skipped (duplicates)'),
    sa.Column('records_failed', sa.Integer(), nullable=False, comment='Failed records'),
    sa.Column('records_mapped', sa.Integer(), nullable=False, comment='Auto-mapped to drivers'),
    sa.Column('records_posted', sa.Integer(), nullable=False, comment='Posted to ledger'),
    sa.Column('perform_matching', sa.Boolean(), nullable=False, comment='Whether to auto-match with CURB trips'),
    sa.Column('post_to_ledger', sa.Boolean(), nullable=False, comment='Whether to post matched violations to ledger'),
    sa.Column('auto_match_threshold', sa.Numeric(precision=5, scale=2), nullable=False, comment='Minimum confidence for auto-matching'),
    sa.Column('errors', sa.Text(), nullable=True, comment='JSON array of error messages'),
    sa.Column('triggered_by', sa.String(length=32), nullable=False, comment='API, CELERY, or MANUAL'),
    sa.Column('triggered_by_user_id', sa.Integer(), nullable=True, comment='User who triggered import (if manual)'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['triggered_by_user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_pvb_import_status_date', 'pvb_import_history', ['status', 'started_at'], unique=False)
    op.create_index(op.f('ix_pvb_import_history_batch_id'), 'pvb_import_history', ['batch_id'], unique=True)
    op.create_index(op.f('ix_pvb_import_history_id'), 'pvb_import_history', ['id'], unique=False)
    op.create_index(op.f('ix_pvb_import_history_status'), 'pvb_import_history', ['status'], unique=False)
    op.create_table('driver_loans',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('loan_id', sa.String(length=50), nullable=False, comment='Unique loan identifier (DL-YYYY-NNNN)'),
    sa.Column('loan_number', sa.String(length=50), nullable=True, comment='Display number for UI'),
    sa.Column('driver_id', sa.Integer(), nullable=False, comment='Borrower driver'),
    sa.Column('lease_id', sa.Integer(), nullable=False, comment='Associated lease'),
    sa.Column('loan_amount', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Principal amount'),
    sa.Column('interest_rate', sa.DECIMAL(precision=5, scale=2), nullable=False, comment='Annual percentage rate'),
    sa.Column('purpose', sa.String(length=255), nullable=True, comment='Reason for loan'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Additional notes'),
    sa.Column('loan_date', sa.Date(), nullable=False, comment='When loan created'),
    sa.Column('start_week', sa.Date(), nullable=False, comment='Sunday when payments start'),
    sa.Column('end_week', sa.Date(), nullable=True, comment='Estimated completion'),
    sa.Column('status', sa.Enum('DRAFT', 'ACTIVE', 'CLOSED', 'ON_HOLD', 'CANCELLED', name='loanstatus'), nullable=False, comment='Loan status'),
    sa.Column('total_principal_paid', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Principal paid to date'),
    sa.Column('total_interest_paid', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Interest paid to date'),
    sa.Column('outstanding_balance', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Amount still owed'),
    sa.Column('approved_by', sa.Integer(), nullable=True, comment='User who approved'),
    sa.Column('approved_on', sa.DateTime(), nullable=True, comment='Approval timestamp'),
    sa.Column('closed_on', sa.Date(), nullable=True, comment='When fully paid'),
    sa.Column('closure_reason', sa.String(length=255), nullable=True, comment='Why closed'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.CheckConstraint('interest_rate >= 0 AND interest_rate <= 100', name='check_interest_rate_range'),
    sa.CheckConstraint('loan_amount > 0', name='check_loan_amount_positive'),
    sa.CheckConstraint('outstanding_balance >= 0', name='check_outstanding_balance_positive'),
    sa.ForeignKeyConstraint(['approved_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['driver_id'], ['drivers.id'], ),
    sa.ForeignKeyConstraint(['lease_id'], ['leases.id'], ),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_driver_lease', 'driver_loans', ['driver_id', 'lease_id'], unique=False)
    op.create_index('idx_status_start_week', 'driver_loans', ['status', 'start_week'], unique=False)
    op.create_index(op.f('ix_driver_loans_driver_id'), 'driver_loans', ['driver_id'], unique=False)
    op.create_index(op.f('ix_driver_loans_id'), 'driver_loans', ['id'], unique=False)
    op.create_index(op.f('ix_driver_loans_lease_id'), 'driver_loans', ['lease_id'], unique=False)
    op.create_index(op.f('ix_driver_loans_loan_date'), 'driver_loans', ['loan_date'], unique=False)
    op.create_index(op.f('ix_driver_loans_loan_id'), 'driver_loans', ['loan_id'], unique=True)
    op.create_index(op.f('ix_driver_loans_start_week'), 'driver_loans', ['start_week'], unique=False)
    op.create_index(op.f('ix_driver_loans_status'), 'driver_loans', ['status'], unique=False)
    op.create_table('ezpass_transactions',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('ticket_number', sa.String(length=100), nullable=False, comment='Unique EZPass ticket/transaction number'),
    sa.Column('transaction_id', sa.String(length=100), nullable=True, comment='Additional transaction ID if provided'),
    sa.Column('posting_date', sa.Date(), nullable=False, comment='Date transaction posted to EZPass account'),
    sa.Column('transaction_date', sa.Date(), nullable=False, comment='Date toll was incurred'),
    sa.Column('transaction_time', sa.String(length=10), nullable=True, comment='Time toll was incurred (HH:MM:SS)'),
    sa.Column('transaction_datetime', sa.DateTime(), nullable=True, comment='Combined transaction date+time'),
    sa.Column('plate_number', sa.String(length=20), nullable=False, comment='Vehicle plate from EZPass'),
    sa.Column('agency', sa.String(length=100), nullable=True, comment='Toll agency (e.g., MTABT, PANYNJ)'),
    sa.Column('activity', sa.String(length=100), nullable=True, comment='Activity type'),
    sa.Column('plaza_id', sa.String(length=50), nullable=True, comment='Plaza identifier'),
    sa.Column('entry_time', sa.String(length=10), nullable=True, comment='Entry time'),
    sa.Column('entry_plaza', sa.String(length=100), nullable=True, comment='Entry plaza name'),
    sa.Column('entry_lane', sa.String(length=100), nullable=True, comment='Entry lane'),
    sa.Column('exit_time', sa.String(length=10), nullable=True, comment='Exit time'),
    sa.Column('exit_plaza', sa.String(length=100), nullable=True, comment='Exit plaza name'),
    sa.Column('exit_lane', sa.String(length=100), nullable=True, comment='Exit lane'),
    sa.Column('vehicle_type_code', sa.String(length=50), nullable=True, comment='Vehicle type code'),
    sa.Column('toll_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Toll charge amount'),
    sa.Column('prepaid', sa.String(length=50), nullable=True, comment='Prepaid indicator'),
    sa.Column('plan_rate', sa.String(length=100), nullable=True, comment='Plan or rate type'),
    sa.Column('fare_type', sa.String(length=100), nullable=True, comment='Fare type'),
    sa.Column('balance', sa.Numeric(precision=10, scale=2), nullable=True, comment='Account balance after transaction'),
    sa.Column('vehicle_id', sa.Integer(), nullable=True, comment='Mapped BAT vehicle'),
    sa.Column('driver_id', sa.Integer(), nullable=True, comment='Mapped BAT driver'),
    sa.Column('lease_id', sa.Integer(), nullable=True, comment='Mapped BAT lease'),
    sa.Column('medallion_id', sa.Integer(), nullable=True, comment='Mapped BAT medallion'),
    sa.Column('hack_license_number', sa.String(length=50), nullable=True, comment='TLC license from CURB matching'),
    sa.Column('matched_trip_id', sa.String(length=100), nullable=True, comment='Reference to curb_trips.record_id'),
    sa.Column('mapping_method', sa.Enum('AUTO_CURB_MATCH', 'MANUAL_ASSIGNMENT', 'UNKNOWN', name='mappingmethod'), nullable=False, comment='How driver/lease was determined'),
    sa.Column('mapping_confidence', sa.Numeric(precision=3, scale=2), nullable=True, comment='Confidence score 0.00-1.00 for auto-matching'),
    sa.Column('mapping_notes', sa.Text(), nullable=True, comment='Notes about mapping process'),
    sa.Column('payment_period_start', sa.Date(), nullable=False, comment='Sunday of payment week'),
    sa.Column('payment_period_end', sa.Date(), nullable=False, comment='Saturday of payment week'),
    sa.Column('import_batch_id', sa.String(length=100), nullable=False, comment='Reference to import batch'),
    sa.Column('imported_on', sa.DateTime(), nullable=False, comment='When imported into system'),
    sa.Column('posting_status', sa.Enum('NOT_POSTED', 'POSTED', 'FAILED', name='postingstatus'), nullable=False, comment='Ledger posting status'),
    sa.Column('ledger_balance_id', sa.String(length=50), nullable=True, comment='Reference to ledger_balances.balance_id'),
    sa.Column('posted_on', sa.DateTime(), nullable=True, comment='When posted to ledger'),
    sa.Column('posting_error', sa.Text(), nullable=True, comment='Error message if posting failed'),
    sa.Column('resolution_status', sa.Enum('UNRESOLVED', 'RESOLVED', name='resolutionstatus'), nullable=False, comment='Payment resolution status'),
    sa.Column('resolved_on', sa.DateTime(), nullable=True, comment='When marked as resolved'),
    sa.Column('remapped_from_driver_id', sa.Integer(), nullable=True, comment='Previous driver if remapped'),
    sa.Column('remapped_on', sa.DateTime(), nullable=True, comment='When remapped'),
    sa.Column('remapped_by', sa.Integer(), nullable=True, comment='User who performed remapping'),
    sa.Column('remap_reason', sa.Text(), nullable=True, comment='Reason for remapping'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.CheckConstraint('mapping_confidence IS NULL OR (mapping_confidence >= 0 AND mapping_confidence <= 1)', name='check_mapping_confidence_range'),
    sa.CheckConstraint('toll_amount >= 0', name='check_toll_amount_positive'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['driver_id'], ['drivers.id'], ),
    sa.ForeignKeyConstraint(['lease_id'], ['leases.id'], ),
    sa.ForeignKeyConstraint(['medallion_id'], ['medallions.id'], ),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['remapped_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['vehicle_id'], ['vehicles.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ezpass_driver_period', 'ezpass_transactions', ['driver_id', 'payment_period_start'], unique=False)
    op.create_index('idx_ezpass_import_batch', 'ezpass_transactions', ['import_batch_id'], unique=False)
    op.create_index('idx_ezpass_payment_period', 'ezpass_transactions', ['payment_period_start', 'payment_period_end'], unique=False)
    op.create_index('idx_ezpass_plate_date', 'ezpass_transactions', ['plate_number', 'transaction_date'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_driver_id'), 'ezpass_transactions', ['driver_id'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_hack_license_number'), 'ezpass_transactions', ['hack_license_number'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_import_batch_id'), 'ezpass_transactions', ['import_batch_id'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_lease_id'), 'ezpass_transactions', ['lease_id'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_mapping_method'), 'ezpass_transactions', ['mapping_method'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_matched_trip_id'), 'ezpass_transactions', ['matched_trip_id'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_medallion_id'), 'ezpass_transactions', ['medallion_id'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_payment_period_end'), 'ezpass_transactions', ['payment_period_end'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_payment_period_start'), 'ezpass_transactions', ['payment_period_start'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_plate_number'), 'ezpass_transactions', ['plate_number'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_posting_date'), 'ezpass_transactions', ['posting_date'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_posting_status'), 'ezpass_transactions', ['posting_status'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_resolution_status'), 'ezpass_transactions', ['resolution_status'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_ticket_number'), 'ezpass_transactions', ['ticket_number'], unique=True)
    op.create_index(op.f('ix_ezpass_transactions_transaction_date'), 'ezpass_transactions', ['transaction_date'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_transaction_datetime'), 'ezpass_transactions', ['transaction_datetime'], unique=False)
    op.create_index(op.f('ix_ezpass_transactions_vehicle_id'), 'ezpass_transactions', ['vehicle_id'], unique=False)
    op.create_table('interim_payments',
    sa.Column('id', sa.Integer(), nullable=False, comment='Auto-increment primary key'),
    sa.Column('payment_id', sa.String(length=50), nullable=False, comment='Unique payment identifier (IP-YYYY-NNNNNN)'),
    sa.Column('driver_id', sa.Integer(), nullable=False, comment='Reference to driver making payment'),
    sa.Column('lease_id', sa.Integer(), nullable=False, comment='Reference to active lease'),
    sa.Column('vehicle_id', sa.Integer(), nullable=True, comment='Reference to vehicle (optional)'),
    sa.Column('medallion_id', sa.Integer(), nullable=True, comment='Reference to medallion (optional)'),
    sa.Column('payment_date', sa.DateTime(), nullable=False, comment='Date and time when payment was received'),
    sa.Column('payment_method', sa.Enum('CASH', 'CHECK', 'ACH', 'WIRE', 'CREDIT_CARD', 'MONEY_ORDER', name='paymentmethod'), nullable=False, comment='Method of payment (Cash, Check, ACH, etc.)'),
    sa.Column('total_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total payment amount received'),
    sa.Column('allocated_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount allocated across obligations'),
    sa.Column('unallocated_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Amount not yet allocated (should be 0 after processing)'),
    sa.Column('check_number', sa.String(length=100), nullable=True, comment='Check number if payment method is CHECK'),
    sa.Column('reference_number', sa.String(length=100), nullable=True, comment='Transaction reference (ACH confirmation, wire number, etc.)'),
    sa.Column('status', sa.Enum('PENDING', 'POSTED', 'PARTIALLY_POSTED', 'FAILED', 'VOIDED', name='paymentstatus'), nullable=False, comment='Current status of payment processing'),
    sa.Column('posted_to_ledger', sa.Integer(), nullable=False, comment='Flag: 1 = posted to ledger, 0 = not posted'),
    sa.Column('posted_at', sa.DateTime(), nullable=True, comment='Timestamp when payment was posted to ledger'),
    sa.Column('posted_by', sa.Integer(), nullable=True, comment='User who posted the payment to ledger'),
    sa.Column('receipt_number', sa.String(length=50), nullable=True, comment='Receipt number for driver records'),
    sa.Column('receipt_generated_at', sa.DateTime(), nullable=True, comment='Timestamp when receipt was generated'),
    sa.Column('description', sa.Text(), nullable=True, comment='Description of payment purpose'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Internal notes about the payment'),
    sa.Column('received_by', sa.Integer(), nullable=True, comment='Cashier/user who received the payment'),
    sa.Column('error_message', sa.Text(), nullable=True, comment='Error message if posting failed'),
    sa.Column('voided_at', sa.DateTime(), nullable=True, comment='Timestamp when payment was voided'),
    sa.Column('voided_by', sa.Integer(), nullable=True, comment='User who voided the payment'),
    sa.Column('voided_reason', sa.Text(), nullable=True, comment='Reason for voiding the payment'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['driver_id'], ['drivers.id'], ),
    sa.ForeignKeyConstraint(['lease_id'], ['leases.id'], ),
    sa.ForeignKeyConstraint(['medallion_id'], ['medallions.id'], ),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['posted_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['received_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['vehicle_id'], ['vehicles.id'], ),
    sa.ForeignKeyConstraint(['voided_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('receipt_number')
    )
    op.create_index('idx_interim_payment_date', 'interim_payments', ['payment_date'], unique=False)
    op.create_index('idx_interim_payment_driver_date', 'interim_payments', ['driver_id', 'payment_date'], unique=False)
    op.create_index('idx_interim_payment_lease_date', 'interim_payments', ['lease_id', 'payment_date'], unique=False)
    op.create_index('idx_interim_payment_status', 'interim_payments', ['status', 'posted_to_ledger'], unique=False)
    op.create_index(op.f('ix_interim_payments_driver_id'), 'interim_payments', ['driver_id'], unique=False)
    op.create_index(op.f('ix_interim_payments_id'), 'interim_payments', ['id'], unique=False)
    op.create_index(op.f('ix_interim_payments_lease_id'), 'interim_payments', ['lease_id'], unique=False)
    op.create_index(op.f('ix_interim_payments_medallion_id'), 'interim_payments', ['medallion_id'], unique=False)
    op.create_index(op.f('ix_interim_payments_payment_id'), 'interim_payments', ['payment_id'], unique=True)
    op.create_index(op.f('ix_interim_payments_status'), 'interim_payments', ['status'], unique=False)
    op.create_index(op.f('ix_interim_payments_vehicle_id'), 'interim_payments', ['vehicle_id'], unique=False)
    op.create_table('loan_schedules',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('installment_id', sa.String(length=50), nullable=False, comment='Unique installment ID (loan_id-INST-NN)'),
    sa.Column('loan_id', sa.String(length=50), nullable=False, comment='Parent loan'),
    sa.Column('installment_number', sa.Integer(), nullable=False, comment='Sequence number'),
    sa.Column('due_date', sa.Date(), nullable=False, comment='When due'),
    sa.Column('week_start', sa.Date(), nullable=False, comment='Sunday of week'),
    sa.Column('week_end', sa.Date(), nullable=False, comment='Saturday of week'),
    sa.Column('principal_amount', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Principal portion'),
    sa.Column('interest_amount', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Interest portion'),
    sa.Column('total_due', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Principal + Interest'),
    sa.Column('principal_paid', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Principal paid'),
    sa.Column('interest_paid', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Interest paid'),
    sa.Column('outstanding_balance', sa.DECIMAL(precision=10, scale=2), nullable=False, comment='Amount still owed'),
    sa.Column('status', sa.Enum('SCHEDULED', 'DUE', 'POSTED', 'PAID', 'SKIPPED', name='installmentstatus'), nullable=False, comment='Installment status'),
    sa.Column('ledger_balance_id', sa.String(length=50), nullable=True, comment='Reference to ledger balance'),
    sa.Column('posted_to_ledger', sa.Boolean(), nullable=False, comment='Whether posted'),
    sa.Column('posted_on', sa.DateTime(), nullable=True, comment='When posted'),
    sa.Column('posted_by', sa.Integer(), nullable=True, comment='User who posted'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.CheckConstraint('interest_amount >= 0', name='check_interest_non_negative'),
    sa.CheckConstraint('outstanding_balance >= 0', name='check_installment_outstanding_positive'),
    sa.CheckConstraint('principal_amount > 0', name='check_principal_positive'),
    sa.CheckConstraint('total_due = principal_amount + interest_amount', name='check_total_due_calculation'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['loan_id'], ['driver_loans.loan_id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['posted_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_due_date_status', 'loan_schedules', ['due_date', 'status'], unique=False)
    op.create_index('idx_loan_installment', 'loan_schedules', ['loan_id', 'installment_number'], unique=True)
    op.create_index('idx_posted_status', 'loan_schedules', ['posted_to_ledger', 'status'], unique=False)
    op.create_index('idx_week_period', 'loan_schedules', ['week_start', 'week_end'], unique=False)
    op.create_index(op.f('ix_loan_schedules_due_date'), 'loan_schedules', ['due_date'], unique=False)
    op.create_index(op.f('ix_loan_schedules_id'), 'loan_schedules', ['id'], unique=False)
    op.create_index(op.f('ix_loan_schedules_installment_id'), 'loan_schedules', ['installment_id'], unique=True)
    op.create_index(op.f('ix_loan_schedules_loan_id'), 'loan_schedules', ['loan_id'], unique=False)
    op.create_index(op.f('ix_loan_schedules_posted_to_ledger'), 'loan_schedules', ['posted_to_ledger'], unique=False)
    op.create_index(op.f('ix_loan_schedules_status'), 'loan_schedules', ['status'], unique=False)
    op.create_table('payment_allocation_details',
    sa.Column('id', sa.Integer(), nullable=False, comment='Auto-increment primary key'),
    sa.Column('allocation_id', sa.String(length=50), nullable=False, comment='Unique allocation identifier (AL-YYYY-NNNNNN)'),
    sa.Column('payment_id', sa.Integer(), nullable=False, comment='Reference to parent interim payment'),
    sa.Column('category', sa.Enum('LEASE', 'REPAIRS', 'LOANS', 'EZPASS', 'PVB', 'TLC', 'MISC', name='allocationcategory'), nullable=False, comment='Category of obligation being paid (Lease, Repair, Loan, etc.)'),
    sa.Column('ledger_balance_id', sa.String(length=50), nullable=True, comment='Reference to ledger balance being paid'),
    sa.Column('reference_type', sa.String(length=50), nullable=False, comment='Type of reference (REPAIR_INSTALLMENT, LOAN_INSTALLMENT, etc.)'),
    sa.Column('reference_id', sa.String(length=100), nullable=False, comment='ID of the specific obligation being paid'),
    sa.Column('obligation_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Original obligation amount before payment'),
    sa.Column('allocated_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Amount allocated to this obligation'),
    sa.Column('remaining_balance', sa.Numeric(precision=10, scale=2), nullable=False, comment='Balance remaining after this allocation'),
    sa.Column('posted_to_ledger', sa.Integer(), nullable=False, comment='Flag: 1 = posted to ledger, 0 = not posted'),
    sa.Column('ledger_posting_id', sa.String(length=50), nullable=True, comment='Reference to ledger posting created for this allocation'),
    sa.Column('posted_at', sa.DateTime(), nullable=True, comment='Timestamp when allocation was posted to ledger'),
    sa.Column('description', sa.Text(), nullable=True, comment='Description of the obligation'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Internal notes about this allocation'),
    sa.Column('error_message', sa.Text(), nullable=True, comment='Error message if posting failed'),
    sa.Column('allocation_sequence', sa.Integer(), nullable=False, comment='Order of allocation within the payment'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['payment_id'], ['interim_payments.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_allocation_category_ref', 'payment_allocation_details', ['category', 'reference_id'], unique=False)
    op.create_index('idx_allocation_ledger_balance', 'payment_allocation_details', ['ledger_balance_id'], unique=False)
    op.create_index('idx_allocation_payment', 'payment_allocation_details', ['payment_id', 'allocation_sequence'], unique=False)
    op.create_index('idx_allocation_posted', 'payment_allocation_details', ['posted_to_ledger', 'posted_at'], unique=False)
    op.create_index(op.f('ix_payment_allocation_details_allocation_id'), 'payment_allocation_details', ['allocation_id'], unique=True)
    op.create_index(op.f('ix_payment_allocation_details_category'), 'payment_allocation_details', ['category'], unique=False)
    op.create_index(op.f('ix_payment_allocation_details_id'), 'payment_allocation_details', ['id'], unique=False)
    op.create_index(op.f('ix_payment_allocation_details_ledger_balance_id'), 'payment_allocation_details', ['ledger_balance_id'], unique=False)
    op.create_index(op.f('ix_payment_allocation_details_payment_id'), 'payment_allocation_details', ['payment_id'], unique=False)
    op.create_index(op.f('ix_payment_allocation_details_reference_id'), 'payment_allocation_details', ['reference_id'], unique=False)
    op.create_table('pvb_violations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('summons_number', sa.String(length=64), nullable=False, comment='Unique summons/ticket number from DOF'),
    sa.Column('plate_number', sa.String(length=16), nullable=False, comment='Vehicle plate number'),
    sa.Column('state', sa.Enum('NY', 'NJ', 'CT', 'PA', 'OTHER', name='violationstate'), nullable=False, comment='State of plate registration'),
    sa.Column('vehicle_type', sa.String(length=16), nullable=True, comment='Vehicle type code (e.g., OMT for Medallion)'),
    sa.Column('violation_date', sa.DateTime(), nullable=False, comment='Date and time of violation'),
    sa.Column('violation_code', sa.String(length=16), nullable=True, comment='Violation code'),
    sa.Column('violation_description', sa.Text(), nullable=True, comment='Description of violation'),
    sa.Column('county', sa.String(length=8), nullable=True, comment='County code (e.g., MN, BK, QN, BX)'),
    sa.Column('issuing_agency', sa.String(length=64), nullable=True, comment='Agency that issued violation'),
    sa.Column('street_name', sa.String(length=256), nullable=True, comment='Street where violation occurred'),
    sa.Column('intersecting_street', sa.String(length=256), nullable=True, comment='Intersecting street'),
    sa.Column('house_number', sa.String(length=32), nullable=True, comment='House number'),
    sa.Column('fine_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Base fine amount'),
    sa.Column('penalty_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Penalty amount'),
    sa.Column('interest_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Interest amount'),
    sa.Column('reduction_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Reduction amount (if any)'),
    sa.Column('payment_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Amount paid so far'),
    sa.Column('amount_due', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount currently due'),
    sa.Column('violation_status', sa.Enum('PENDING', 'ISSUED', 'PAID', 'DISMISSED', 'HEARING', name='violationstatus'), nullable=False, comment='Current status of violation'),
    sa.Column('judgment_entry_date', sa.DateTime(), nullable=True, comment='Date judgment was entered'),
    sa.Column('hearing_status', sa.String(length=64), nullable=True, comment='Hearing status if applicable'),
    sa.Column('driver_id', sa.Integer(), nullable=True, comment='Mapped driver'),
    sa.Column('vehicle_id', sa.Integer(), nullable=True, comment='Mapped vehicle'),
    sa.Column('medallion_id', sa.Integer(), nullable=True, comment='Mapped medallion'),
    sa.Column('lease_id', sa.Integer(), nullable=True, comment='Active lease at time of violation'),
    sa.Column('hack_license_number', sa.String(length=32), nullable=True, comment='TLC/Hack license number of responsible driver'),
    sa.Column('mapping_method', sa.Enum('AUTO_CURB_MATCH', 'MANUAL_ASSIGNMENT', 'UNMAPPED', name='mappingmethod'), nullable=False, comment='How violation was mapped to driver'),
    sa.Column('mapping_confidence', sa.Numeric(precision=5, scale=2), nullable=True, comment='Confidence score (0.00-1.00) for auto-matching'),
    sa.Column('matched_curb_trip_id', sa.BigInteger(), nullable=True, comment='CURB trip used for matching'),
    sa.Column('mapping_notes', sa.Text(), nullable=True, comment='Notes about mapping (especially for manual assignments)'),
    sa.Column('mapped_at', sa.DateTime(), nullable=True, comment='When mapping was performed'),
    sa.Column('mapped_by', sa.Integer(), nullable=True, comment='User who performed manual mapping'),
    sa.Column('posting_status', sa.Enum('NOT_POSTED', 'POSTED', 'FAILED', name='postingstatus'), nullable=False, comment='Whether posted to ledger'),
    sa.Column('ledger_posting_id', sa.String(length=64), nullable=True, comment='Reference to ledger_postings.posting_id'),
    sa.Column('ledger_balance_id', sa.String(length=64), nullable=True, comment='Reference to ledger_balances.balance_id'),
    sa.Column('payment_period_start', sa.DateTime(), nullable=True, comment='Payment period start (Sunday 00:00)'),
    sa.Column('payment_period_end', sa.DateTime(), nullable=True, comment='Payment period end (Saturday 23:59)'),
    sa.Column('posted_at', sa.DateTime(), nullable=True, comment='When posted to ledger'),
    sa.Column('posting_error', sa.Text(), nullable=True, comment='Error message if posting failed'),
    sa.Column('import_source', sa.Enum('DOF_CSV', 'MANUAL_ENTRY', 'EMAIL', 'MAIL', name='violationsource'), nullable=False, comment='Source of this violation record'),
    sa.Column('import_batch_id', sa.String(length=64), nullable=True, comment='Import batch identifier'),
    sa.Column('import_file_name', sa.String(length=256), nullable=True, comment='Original filename if from CSV/file'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.CheckConstraint('amount_due >= 0', name='check_amount_due_positive'),
    sa.CheckConstraint('fine_amount >= 0', name='check_fine_positive'),
    sa.CheckConstraint('mapping_confidence IS NULL OR (mapping_confidence >= 0 AND mapping_confidence <= 1)', name='check_confidence_range'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['driver_id'], ['drivers.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['lease_id'], ['leases.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['mapped_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['matched_curb_trip_id'], ['curb_trips.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['medallion_id'], ['medallions.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['vehicle_id'], ['vehicles.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('summons_number', name='uq_pvb_summons_number')
    )
    op.create_index('idx_pvb_driver_status', 'pvb_violations', ['driver_id', 'posting_status'], unique=False)
    op.create_index('idx_pvb_mapping', 'pvb_violations', ['mapping_method', 'posting_status'], unique=False)
    op.create_index('idx_pvb_plate_date', 'pvb_violations', ['plate_number', 'violation_date'], unique=False)
    op.create_index(op.f('ix_pvb_violations_driver_id'), 'pvb_violations', ['driver_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_hack_license_number'), 'pvb_violations', ['hack_license_number'], unique=False)
    op.create_index(op.f('ix_pvb_violations_id'), 'pvb_violations', ['id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_import_batch_id'), 'pvb_violations', ['import_batch_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_lease_id'), 'pvb_violations', ['lease_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_ledger_balance_id'), 'pvb_violations', ['ledger_balance_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_ledger_posting_id'), 'pvb_violations', ['ledger_posting_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_mapping_method'), 'pvb_violations', ['mapping_method'], unique=False)
    op.create_index(op.f('ix_pvb_violations_medallion_id'), 'pvb_violations', ['medallion_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_plate_number'), 'pvb_violations', ['plate_number'], unique=False)
    op.create_index(op.f('ix_pvb_violations_posting_status'), 'pvb_violations', ['posting_status'], unique=False)
    op.create_index(op.f('ix_pvb_violations_summons_number'), 'pvb_violations', ['summons_number'], unique=True)
    op.create_index(op.f('ix_pvb_violations_vehicle_id'), 'pvb_violations', ['vehicle_id'], unique=False)
    op.create_index(op.f('ix_pvb_violations_violation_date'), 'pvb_violations', ['violation_date'], unique=False)
    op.create_index(op.f('ix_pvb_violations_violation_status'), 'pvb_violations', ['violation_status'], unique=False)
    op.create_table('repair_installments',
    sa.Column('installment_id', sa.String(length=60), nullable=False, comment='Unique installment ID (e.g., RPR-2025-001-01)'),
    sa.Column('repair_id', sa.Integer(), nullable=False, comment='Parent repair invoice ID'),
    sa.Column('installment_number', sa.Integer(), nullable=False, comment='Sequential number within repair (1, 2, 3...)'),
    sa.Column('driver_id', sa.Integer(), nullable=False, comment='Driver ID from parent repair'),
    sa.Column('lease_id', sa.Integer(), nullable=False, comment='Lease ID from parent repair'),
    sa.Column('vehicle_id', sa.Integer(), nullable=True, comment='Vehicle ID from parent repair'),
    sa.Column('medallion_id', sa.Integer(), nullable=True, comment='Medallion ID from parent repair'),
    sa.Column('week_start', sa.Date(), nullable=False, comment='Sunday 00:00:00 - start of payment week'),
    sa.Column('week_end', sa.Date(), nullable=False, comment='Saturday 23:59:59 - end of payment week'),
    sa.Column('due_date', sa.Date(), nullable=False, comment='Due date for this installment (typically Saturday)'),
    sa.Column('installment_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Amount due for this installment'),
    sa.Column('amount_paid', sa.Numeric(precision=10, scale=2), nullable=False, comment='Amount actually paid for this installment'),
    sa.Column('prior_balance', sa.Numeric(precision=10, scale=2), nullable=False, comment='Unpaid balance carried forward from previous periods'),
    sa.Column('balance', sa.Numeric(precision=10, scale=2), nullable=False, comment='Remaining balance after this installment'),
    sa.Column('status', sa.Enum('SCHEDULED', 'DUE', 'POSTED', 'PAID', name='installmentstatus'), nullable=False, comment='Current status of installment'),
    sa.Column('posted_to_ledger', sa.Integer(), nullable=False, comment='0=not posted, 1=posted to ledger'),
    sa.Column('ledger_posting_id', sa.String(length=50), nullable=True, comment='Ledger posting ID when posted'),
    sa.Column('ledger_balance_id', sa.String(length=50), nullable=True, comment='Ledger balance ID when posted'),
    sa.Column('posted_at', sa.DateTime(), nullable=True, comment='Timestamp when posted to ledger'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='Flag indicating if the record is archived'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='Flag to keep track of record is active or not'),
    sa.Column('created_by', sa.Integer(), nullable=True, comment='User who created this record'),
    sa.Column('modified_by', sa.Integer(), nullable=True, comment='User who last modified this record'),
    sa.Column('created_on', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True, comment='Timestamp when this record was created'),
    sa.Column('updated_on', sa.DateTime(timezone=True), nullable=True, comment='Timestamp when this record was last updated'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['modified_by'], ['users.id'], onupdate='CASCADE', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['repair_id'], ['vehicle_repairs.id'], ),
    sa.PrimaryKeyConstraint('installment_id')
    )
    op.create_index('idx_installments_driver_status', 'repair_installments', ['driver_id', 'status'], unique=False)
    op.create_index('idx_installments_lease', 'repair_installments', ['lease_id', 'status'], unique=False)
    op.create_index('idx_installments_repair', 'repair_installments', ['repair_id', 'installment_number'], unique=False)
    op.create_index('idx_installments_unposted', 'repair_installments', ['posted_to_ledger', 'week_start'], unique=False)
    op.create_index('idx_installments_week_start', 'repair_installments', ['week_start'], unique=False)
    op.create_index(op.f('ix_repair_installments_driver_id'), 'repair_installments', ['driver_id'], unique=False)
    op.create_index(op.f('ix_repair_installments_due_date'), 'repair_installments', ['due_date'], unique=False)
    op.create_index(op.f('ix_repair_installments_lease_id'), 'repair_installments', ['lease_id'], unique=False)
    op.create_index(op.f('ix_repair_installments_medallion_id'), 'repair_installments', ['medallion_id'], unique=False)
    op.create_index(op.f('ix_repair_installments_posted_to_ledger'), 'repair_installments', ['posted_to_ledger'], unique=False)
    op.create_index(op.f('ix_repair_installments_repair_id'), 'repair_installments', ['repair_id'], unique=False)
    op.create_index(op.f('ix_repair_installments_status'), 'repair_installments', ['status'], unique=False)
    op.create_index(op.f('ix_repair_installments_vehicle_id'), 'repair_installments', ['vehicle_id'], unique=False)
    op.create_index(op.f('ix_repair_installments_week_start'), 'repair_installments', ['week_start'], unique=False)
    op.add_column('vehicle_repairs', sa.Column('repair_id', sa.String(length=50), nullable=False, comment='Unique repair identifier (e.g., RPR-2025-001)'))
    op.add_column('vehicle_repairs', sa.Column('driver_id', sa.Integer(), nullable=False, comment='Driver responsible for repair payment'))
    op.add_column('vehicle_repairs', sa.Column('lease_id', sa.Integer(), nullable=False, comment='Active lease at time of repair'))
    op.add_column('vehicle_repairs', sa.Column('medallion_id', sa.Integer(), nullable=True, comment='Medallion associated with vehicle'))
    op.add_column('vehicle_repairs', sa.Column('vin', sa.String(length=50), nullable=True, comment='Vehicle VIN number'))
    op.add_column('vehicle_repairs', sa.Column('plate_number', sa.String(length=20), nullable=True, comment='Vehicle plate number'))
    op.add_column('vehicle_repairs', sa.Column('hack_license', sa.String(length=50), nullable=True, comment='Driver TLC hack license number'))
    op.add_column('vehicle_repairs', sa.Column('invoice_number', sa.String(length=100), nullable=False, comment='Repair invoice number from workshop'))
    op.add_column('vehicle_repairs', sa.Column('workshop_type', sa.Enum('BIG_APPLE', 'EXTERNAL', name='workshoptype'), nullable=False, comment='Big Apple Workshop or External Workshop'))
    op.add_column('vehicle_repairs', sa.Column('repair_description', sa.Text(), nullable=True, comment='Description of repair work performed'))
    op.add_column('vehicle_repairs', sa.Column('repair_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total repair invoice amount'))
    op.add_column('vehicle_repairs', sa.Column('start_week', sa.Enum('CURRENT', 'NEXT', name='startweekoption'), nullable=False, comment='When repayments begin (Current or Next period)'))
    op.add_column('vehicle_repairs', sa.Column('start_week_date', sa.Date(), nullable=False, comment='Actual Sunday date when first installment is due'))
    op.add_column('vehicle_repairs', sa.Column('weekly_installment_amount', sa.Numeric(precision=10, scale=2), nullable=False, comment='Standard weekly installment from payment matrix'))
    op.add_column('vehicle_repairs', sa.Column('total_paid', sa.Numeric(precision=10, scale=2), nullable=False, comment='Total amount paid to date across all installments'))
    op.add_column('vehicle_repairs', sa.Column('outstanding_balance', sa.Numeric(precision=10, scale=2), nullable=False, comment='Remaining unpaid balance'))
    op.add_column('vehicle_repairs', sa.Column('hold_reason', sa.Text(), nullable=True, comment='Reason if status is HOLD'))
    op.add_column('vehicle_repairs', sa.Column('cancelled_reason', sa.Text(), nullable=True, comment='Reason if status is CANCELLED'))
    op.add_column('vehicle_repairs', sa.Column('invoice_document_id', sa.Integer(), nullable=True, comment='Link to uploaded invoice document'))
    op.add_column('vehicle_repairs', sa.Column('confirmed_at', sa.DateTime(), nullable=True, comment='When invoice was confirmed and schedule generated'))
    op.add_column('vehicle_repairs', sa.Column('closed_at', sa.DateTime(), nullable=True, comment='When all installments were paid and balance = 0'))
    op.alter_column('vehicle_repairs', 'id',
               existing_type=mysql.INTEGER(),
               comment='Internal unique identifier',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('vehicle_repairs', 'vehicle_id',
               existing_type=mysql.INTEGER(),
               comment='Vehicle that was repaired',
               existing_nullable=False)
    op.alter_column('vehicle_repairs', 'invoice_date',
               existing_type=sa.DATE(),
               nullable=False,
               comment='Date repair invoice was issued')
    op.alter_column('vehicle_repairs', 'status',
               existing_type=mysql.VARCHAR(length=20),
               type_=sa.Enum('DRAFT', 'OPEN', 'CLOSED', 'HOLD', 'CANCELLED', name='repairstatus'),
               comment='Current status of repair invoice',
               existing_nullable=False)
    op.create_index('idx_repairs_driver_status', 'vehicle_repairs', ['driver_id', 'status'], unique=False)
    op.create_index('idx_repairs_invoice_date', 'vehicle_repairs', ['invoice_date'], unique=False)
    op.create_index('idx_repairs_lease_status', 'vehicle_repairs', ['lease_id', 'status'], unique=False)
    op.create_index('idx_repairs_vehicle', 'vehicle_repairs', ['vehicle_id'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_driver_id'), 'vehicle_repairs', ['driver_id'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_invoice_date'), 'vehicle_repairs', ['invoice_date'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_invoice_number'), 'vehicle_repairs', ['invoice_number'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_lease_id'), 'vehicle_repairs', ['lease_id'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_medallion_id'), 'vehicle_repairs', ['medallion_id'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_plate_number'), 'vehicle_repairs', ['plate_number'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_status'), 'vehicle_repairs', ['status'], unique=False)
    op.create_index(op.f('ix_vehicle_repairs_vehicle_id'), 'vehicle_repairs', ['vehicle_id'], unique=False)
    op.create_unique_constraint(None, 'vehicle_repairs', ['repair_id'])
    op.create_foreign_key(None, 'vehicle_repairs', 'drivers', ['driver_id'], ['id'])
    op.create_foreign_key(None, 'vehicle_repairs', 'document', ['invoice_document_id'], ['id'])
    op.create_foreign_key(None, 'vehicle_repairs', 'medallions', ['medallion_id'], ['id'])
    op.create_foreign_key(None, 'vehicle_repairs', 'leases', ['lease_id'], ['id'])
    op.drop_column('vehicle_repairs', 'remarks')
    op.drop_column('vehicle_repairs', 'vehicle_out_time')
    op.drop_column('vehicle_repairs', 'vehicle_in_date')
    op.drop_column('vehicle_repairs', 'next_service_due_by')
    op.drop_column('vehicle_repairs', 'invoice_amount')
    op.drop_column('vehicle_repairs', 'repair_paid_by')
    op.drop_column('vehicle_repairs', 'vehicle_out_date')
    op.drop_column('vehicle_repairs', 'vehicle_in_time')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('vehicle_repairs', sa.Column('vehicle_in_time', mysql.VARCHAR(length=10), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('vehicle_out_date', sa.DATE(), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('repair_paid_by', mysql.VARCHAR(length=10), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('invoice_amount', mysql.FLOAT(), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('next_service_due_by', sa.DATE(), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('vehicle_in_date', sa.DATE(), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('vehicle_out_time', mysql.VARCHAR(length=10), nullable=True))
    op.add_column('vehicle_repairs', sa.Column('remarks', mysql.TEXT(), nullable=True))
    op.drop_constraint(None, 'vehicle_repairs', type_='foreignkey')
    op.drop_constraint(None, 'vehicle_repairs', type_='foreignkey')
    op.drop_constraint(None, 'vehicle_repairs', type_='foreignkey')
    op.drop_constraint(None, 'vehicle_repairs', type_='foreignkey')
    op.drop_constraint(None, 'vehicle_repairs', type_='unique')
    op.drop_index(op.f('ix_vehicle_repairs_vehicle_id'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_status'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_plate_number'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_medallion_id'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_lease_id'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_invoice_number'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_invoice_date'), table_name='vehicle_repairs')
    op.drop_index(op.f('ix_vehicle_repairs_driver_id'), table_name='vehicle_repairs')
    op.drop_index('idx_repairs_vehicle', table_name='vehicle_repairs')
    op.drop_index('idx_repairs_lease_status', table_name='vehicle_repairs')
    op.drop_index('idx_repairs_invoice_date', table_name='vehicle_repairs')
    op.drop_index('idx_repairs_driver_status', table_name='vehicle_repairs')
    op.alter_column('vehicle_repairs', 'status',
               existing_type=sa.Enum('DRAFT', 'OPEN', 'CLOSED', 'HOLD', 'CANCELLED', name='repairstatus'),
               type_=mysql.VARCHAR(length=20),
               comment=None,
               existing_comment='Current status of repair invoice',
               existing_nullable=False)
    op.alter_column('vehicle_repairs', 'invoice_date',
               existing_type=sa.DATE(),
               nullable=True,
               comment=None,
               existing_comment='Date repair invoice was issued')
    op.alter_column('vehicle_repairs', 'vehicle_id',
               existing_type=mysql.INTEGER(),
               comment=None,
               existing_comment='Vehicle that was repaired',
               existing_nullable=False)
    op.alter_column('vehicle_repairs', 'id',
               existing_type=mysql.INTEGER(),
               comment=None,
               existing_comment='Internal unique identifier',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('vehicle_repairs', 'closed_at')
    op.drop_column('vehicle_repairs', 'confirmed_at')
    op.drop_column('vehicle_repairs', 'invoice_document_id')
    op.drop_column('vehicle_repairs', 'cancelled_reason')
    op.drop_column('vehicle_repairs', 'hold_reason')
    op.drop_column('vehicle_repairs', 'outstanding_balance')
    op.drop_column('vehicle_repairs', 'total_paid')
    op.drop_column('vehicle_repairs', 'weekly_installment_amount')
    op.drop_column('vehicle_repairs', 'start_week_date')
    op.drop_column('vehicle_repairs', 'start_week')
    op.drop_column('vehicle_repairs', 'repair_amount')
    op.drop_column('vehicle_repairs', 'repair_description')
    op.drop_column('vehicle_repairs', 'workshop_type')
    op.drop_column('vehicle_repairs', 'invoice_number')
    op.drop_column('vehicle_repairs', 'hack_license')
    op.drop_column('vehicle_repairs', 'plate_number')
    op.drop_column('vehicle_repairs', 'vin')
    op.drop_column('vehicle_repairs', 'medallion_id')
    op.drop_column('vehicle_repairs', 'lease_id')
    op.drop_column('vehicle_repairs', 'driver_id')
    op.drop_column('vehicle_repairs', 'repair_id')
    op.drop_index(op.f('ix_repair_installments_week_start'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_vehicle_id'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_status'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_repair_id'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_posted_to_ledger'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_medallion_id'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_lease_id'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_due_date'), table_name='repair_installments')
    op.drop_index(op.f('ix_repair_installments_driver_id'), table_name='repair_installments')
    op.drop_index('idx_installments_week_start', table_name='repair_installments')
    op.drop_index('idx_installments_unposted', table_name='repair_installments')
    op.drop_index('idx_installments_repair', table_name='repair_installments')
    op.drop_index('idx_installments_lease', table_name='repair_installments')
    op.drop_index('idx_installments_driver_status', table_name='repair_installments')
    op.drop_table('repair_installments')
    op.drop_index(op.f('ix_pvb_violations_violation_status'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_violation_date'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_vehicle_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_summons_number'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_posting_status'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_plate_number'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_medallion_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_mapping_method'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_ledger_posting_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_ledger_balance_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_lease_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_import_batch_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_id'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_hack_license_number'), table_name='pvb_violations')
    op.drop_index(op.f('ix_pvb_violations_driver_id'), table_name='pvb_violations')
    op.drop_index('idx_pvb_plate_date', table_name='pvb_violations')
    op.drop_index('idx_pvb_mapping', table_name='pvb_violations')
    op.drop_index('idx_pvb_driver_status', table_name='pvb_violations')
    op.drop_table('pvb_violations')
    op.drop_index(op.f('ix_payment_allocation_details_reference_id'), table_name='payment_allocation_details')
    op.drop_index(op.f('ix_payment_allocation_details_payment_id'), table_name='payment_allocation_details')
    op.drop_index(op.f('ix_payment_allocation_details_ledger_balance_id'), table_name='payment_allocation_details')
    op.drop_index(op.f('ix_payment_allocation_details_id'), table_name='payment_allocation_details')
    op.drop_index(op.f('ix_payment_allocation_details_category'), table_name='payment_allocation_details')
    op.drop_index(op.f('ix_payment_allocation_details_allocation_id'), table_name='payment_allocation_details')
    op.drop_index('idx_allocation_posted', table_name='payment_allocation_details')
    op.drop_index('idx_allocation_payment', table_name='payment_allocation_details')
    op.drop_index('idx_allocation_ledger_balance', table_name='payment_allocation_details')
    op.drop_index('idx_allocation_category_ref', table_name='payment_allocation_details')
    op.drop_table('payment_allocation_details')
    op.drop_index(op.f('ix_loan_schedules_status'), table_name='loan_schedules')
    op.drop_index(op.f('ix_loan_schedules_posted_to_ledger'), table_name='loan_schedules')
    op.drop_index(op.f('ix_loan_schedules_loan_id'), table_name='loan_schedules')
    op.drop_index(op.f('ix_loan_schedules_installment_id'), table_name='loan_schedules')
    op.drop_index(op.f('ix_loan_schedules_id'), table_name='loan_schedules')
    op.drop_index(op.f('ix_loan_schedules_due_date'), table_name='loan_schedules')
    op.drop_index('idx_week_period', table_name='loan_schedules')
    op.drop_index('idx_posted_status', table_name='loan_schedules')
    op.drop_index('idx_loan_installment', table_name='loan_schedules')
    op.drop_index('idx_due_date_status', table_name='loan_schedules')
    op.drop_table('loan_schedules')
    op.drop_index(op.f('ix_interim_payments_vehicle_id'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_status'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_payment_id'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_medallion_id'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_lease_id'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_id'), table_name='interim_payments')
    op.drop_index(op.f('ix_interim_payments_driver_id'), table_name='interim_payments')
    op.drop_index('idx_interim_payment_status', table_name='interim_payments')
    op.drop_index('idx_interim_payment_lease_date', table_name='interim_payments')
    op.drop_index('idx_interim_payment_driver_date', table_name='interim_payments')
    op.drop_index('idx_interim_payment_date', table_name='interim_payments')
    op.drop_table('interim_payments')
    op.drop_index(op.f('ix_ezpass_transactions_vehicle_id'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_transaction_datetime'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_transaction_date'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_ticket_number'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_resolution_status'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_posting_status'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_posting_date'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_plate_number'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_payment_period_start'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_payment_period_end'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_medallion_id'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_matched_trip_id'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_mapping_method'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_lease_id'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_import_batch_id'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_hack_license_number'), table_name='ezpass_transactions')
    op.drop_index(op.f('ix_ezpass_transactions_driver_id'), table_name='ezpass_transactions')
    op.drop_index('idx_ezpass_plate_date', table_name='ezpass_transactions')
    op.drop_index('idx_ezpass_payment_period', table_name='ezpass_transactions')
    op.drop_index('idx_ezpass_import_batch', table_name='ezpass_transactions')
    op.drop_index('idx_ezpass_driver_period', table_name='ezpass_transactions')
    op.drop_table('ezpass_transactions')
    op.drop_index(op.f('ix_driver_loans_status'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_start_week'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_loan_id'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_loan_date'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_lease_id'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_id'), table_name='driver_loans')
    op.drop_index(op.f('ix_driver_loans_driver_id'), table_name='driver_loans')
    op.drop_index('idx_status_start_week', table_name='driver_loans')
    op.drop_index('idx_driver_lease', table_name='driver_loans')
    op.drop_table('driver_loans')
    op.drop_index(op.f('ix_pvb_import_history_status'), table_name='pvb_import_history')
    op.drop_index(op.f('ix_pvb_import_history_id'), table_name='pvb_import_history')
    op.drop_index(op.f('ix_pvb_import_history_batch_id'), table_name='pvb_import_history')
    op.drop_index('idx_pvb_import_status_date', table_name='pvb_import_history')
    op.drop_table('pvb_import_history')
    op.drop_index(op.f('ix_ezpass_import_history_status'), table_name='ezpass_import_history')
    op.drop_index(op.f('ix_ezpass_import_history_batch_id'), table_name='ezpass_import_history')
    op.drop_index('idx_ezpass_history_status', table_name='ezpass_import_history')
    op.drop_index('idx_ezpass_history_started', table_name='ezpass_import_history')
    op.drop_index('idx_ezpass_history_dates', table_name='ezpass_import_history')
    op.drop_table('ezpass_import_history')
    # ### end Alembic commands ###
